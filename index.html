<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>3D 태양계 — AU 단위 + OrbitControls</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html,body{height:100%;margin:0;background:#061024;color:#e9f2ff;font:12px/1.4 system-ui}
#app{position:fixed; inset:0}
canvas{display:block; width:100%; height:100%}
.ui{
  position:fixed; left:12px; top:12px; background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:10px;
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; max-width:96vw; z-index:20;
}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{cursor:pointer; padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.02)}
.btn:hover{background:rgba(255,255,255,.04)}
input[type="range"]{width:200px}
select,input[type="number"]{background:transparent; color:#e9f2ff; border:1px solid rgba(255,255,255,.06); border-radius:6px; padding:4px}
.hint{opacity:.7;font-size:12px;color:#bcd}
</style>
</head>
<body>
<div id="app"></div>

<div class="ui">
  <div class="row">
    <label for="speed">속도</label>
    <input id="speed" type="range" min="0" max="8" step="0.1" value="2">
    <input id="speedNum" type="number" min="0" max="8" step="0.1" value="2" style="width:60px">
    <button class="btn" data-rate="1">1×</button>
    <button class="btn" data-rate="2">2×</button>
    <button class="btn" data-rate="3">3×</button>
  </div>

  <div class="row">
    <label for="focusSel">중심점</label>
    <select id="focusSel">
      <option>자유(수동)</option>
      <option>태양</option>
      <option selected>지구</option>
      <option>수성</option><option>금성</option><option>달</option><option>화성</option>
      <option>목성</option><option>토성</option><option>천왕성</option><option>해왕성</option><option>명왕성</option>
    </select>
    <label><input id="axisToggle" type="checkbox" checked> 자전축 표시</label>
    <span class="hint">• 좌클릭: 회전 · 휠: 줌 · 우클릭: 팬(자유 모드)</span>
  </div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js';

// ---------- Renderer & Scene ----------
const app = document.getElementById('app');
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(app.clientWidth, app.clientHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
app.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x061024);

// ---------- Camera ----------
const camera = new THREE.PerspectiveCamera(60, app.clientWidth/app.clientHeight, 0.01, 2000);
camera.position.set(30,20,50);

// ---------- OrbitControls ----------
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.screenSpacePanning = false;

// ---------- Light ----------
const ambientLight = new THREE.AmbientLight(0xffffff,0.35);
scene.add(ambientLight);
const sunLight = new THREE.PointLight(0xffffff,2.6,0,2);
scene.add(sunLight);

// ---------- Helper: axis ----------
function axisMesh(len, thick=0.02){
  const g = new THREE.CylinderGeometry(thick, thick, len,12);
  const m = new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.7});
  const cyl = new THREE.Mesh(g,m);
  cyl.rotation.z=Math.PI/2;
  return cyl;
}

// ---------- Containers ----------
const bodies = {};
const axisList = [];

// ---------- Scale ----------
const SIZE = 1;

// ---------- Sun ----------
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(1.3927,64,64), // Sun diameter ~1.3927 AU / 100 scale
  new THREE.MeshBasicMaterial({color:0xffd97a})
);
scene.add(sun);
sunLight.position.copy(sun.position);

// ---------- Planet Definitions (AU 기준) ----------
const planetDefs = [
  {name:'수성', a:0.387, e:0.20564, inclination:7, size:0.0049, color:0xb4b4b4, rotVel:0.003, rotDays:58.6462, axialTilt:0.01, orbitDays:87.97},
  {name:'금성', a:0.723, e:0.0068, inclination:3.39, size:0.0121, color:0xd8b47d, rotVel:-0.000175, rotDays:-243.025, axialTilt:177.36, orbitDays:224.701},
  {name:'지구', a:1.0, e:0.0167, inclination:0, size:0.0127, color:0x5fa8ff, rotVel:0.261, rotDays:0.9973, axialTilt:23.44, orbitDays:365.256, moons:[
    {name:'달', a:0.00257, e:0.055, inclination:5.14, size:0.0035, color:0xcfd6ff, rotVel:0.147, rotDays:27.322}
  ]},
  {name:'화성', a:1.524, e:0.0934, inclination:1.85, size:0.0068, color:0xff6b6b, rotVel:0.262, rotDays:1.026, axialTilt:25.19, orbitDays:686.98, moons:[
    {name:'포보스', a:0.0000627, e:0.0151, inclination:1.08, size:0.0012, color:0xaaaaaa, rotVel:0, rotDays:0.3189},
    {name:'데이모스', a:0.000156, e:0.0002, inclination:0.93, size:0.0008, color:0xcccccc, rotVel:0, rotDays:1.263}
  ]},
  {name:'목성', a:5.203, e:0.0489, inclination:1.3, size:0.142, color:0xc89f68, rotVel:2.1, rotDays:0.4135, axialTilt:3.13},
  {name:'토성', a:9.537, e:0.0565, inclination:2.49, size:0.120, color:0xd8cfae, rotVel:2.2, rotDays:0.444, axialTilt:26.73},
  {name:'천왕성', a:19.191, e:0.0457, inclination:0.77, size:0.051, color:0x9bd7ff, rotVel:-0.42, rotDays:-0.718, axialTilt:97.77},
  {name:'해왕성', a:30.07, e:0.0113, inclination:1.77, size:0.049, color:0x6aa7ff, rotVel:0.425, rotDays:0.671, axialTilt:28.32},
  {name:'명왕성', a:39.48, e:0.2488, inclination:17.16, size:0.018, color:0x999999, rotVel:0.071, rotDays:6.39, axialTilt:122.53}
];

// ---------- Create Bodies ----------
const planetStates = [];

function createBody(def){
  const group = new THREE.Group();
  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(def.size,32,32),
    new THREE.MeshStandardMaterial({color:def.color, roughness:0.7})
  );
  group.add(mesh);
  const ax = axisMesh(def.size*3,def.size*0.2);
  group.add(ax);
  axisList.push(ax);

  const moons=[];
  if(def.moons){
    for(const m of def.moons){
      const mBody = createBody(m);
      group.add(mBody.group);
      moons.push({...mBody, orbitAngle:Math.random()*Math.PI*2});
    }
  }

  scene.add(group);

  const b = def.a*Math.sqrt(1-def.e*def.e);

  planetStates.push({
    def, group, mesh, moons,
    a:def.a, b:b, e:def.e,
    orbitAngle:Math.random()*2*Math.PI
  });
  bodies[def.name]=group;
}

planetDefs.forEach(createBody);

// ---------- UI Binding ----------
let timeScale = 2;
const speed = document.getElementById('speed');
const speedNum = document.getElementById('speedNum');
function setRate(v){ timeScale = Number(v); speed.value=v; speedNum.value=v; }
speed.addEventListener('input',e=>setRate(e.target.value));
speedNum.addEventListener('input',e=>setRate(e.target.value));
document.querySelectorAll('.btn[data-rate]').forEach(b=>b.addEventListener('click',()=>setRate(b.dataset.rate)));

const focusSel = document.getElementById('focusSel');
let focusTarget = bodies['지구'];
focusSel.addEventListener('change',()=>{
  const v=focusSel.value;
  focusTarget = v==='자유(수동)'?null:bodies[v]||null;
});

// axis toggle
const axisToggle=document.getElementById('axisToggle');
axisToggle.addEventListener('change',()=>axisList.forEach(ax=>ax.visible=axisToggle.checked));
axisList.forEach(ax=>ax.visible=true);

// ---------- Animation ----------
let last=performance.now();
function tick(now){
  const dtSec=(now-last)/1000; last=now;
  const dtDays = dtSec*timeScale;

  // sun rotation
  sun.rotation.y += dtDays* (2*Math.PI/0.06954); // 항성주기

  // planets
  for(const ps of planetStates){
    const angInc = dtDays*2*Math.PI/ps.def.orbitDays;
    ps.orbitAngle += angInc;

    const x = ps.a*(Math.cos(ps.orbitAngle)-ps.e);
    const z = ps.b*Math.sin(ps.orbitAngle);
    ps.group.position.set(x,0,z);

    // rotation
    if(ps.mesh){
      ps.mesh.rotation.y += dtDays*2*Math.PI/ps.def.rotDays;
    }

    // moons
    ps.moons.forEach(m=>{
      const ma = dtDays*2*Math.PI/m.def.orbitDays;
      m.orbitAngle += ma;
      const mx = m.def.a*Math.cos(m.orbitAngle);
      const mz = m.def.a*Math.sin(m.orbitAngle);
      m.group.position.set(mx,0,mz);
    });
  }

  controls.target.copy(focusTarget?focusTarget.position:new THREE.Vector3(0,0,0));
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

// ---------- Resize ----------
window.addEventListener('resize',()=>{
  camera.aspect = app.clientWidth/app.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(app.clientWidth,app.clientHeight);
});

// ---------- Initial ----------
controls.update();
</script>
</body>
</html>
