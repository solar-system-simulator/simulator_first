<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>3D 태양계 — AU 단위 + 카메라 컨트롤</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html,body{height:100%;margin:0;background:#061024;color:#e9f2ff;font:12px/1.4 system-ui}
#app{position:fixed; inset:0}
canvas{display:block; width:100%; height:100%}
.ui{
  position:fixed; left:12px; top:12px; background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:10px;
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; max-width:96vw; z-index:20;
}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{cursor:pointer; padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.02)}
.btn:hover{background:rgba(255,255,255,.04)}
input[type="range"]{width:200px}
select,input[type="number"]{background:transparent; color:#e9f2ff; border:1px solid rgba(255,255,255,.06); border-radius:6px; padding:4px}
.hint{opacity:.7;font-size:12px;color:#bcd}
</style>
</head>
<body>
<div id="app"></div>

<div class="ui">
  <div class="row">
    <label for="speed">속도</label>
    <input id="speed" type="range" min="0" max="8" step="0.1" value="2">
    <input id="speedNum" type="number" min="0" max="8" step="0.1" value="2" style="width:60px">
    <button class="btn" data-rate="1">1×</button>
    <button class="btn" data-rate="2">2×</button>
    <button class="btn" data-rate="3">3×</button>
  </div>

  <div class="row">
    <label for="focusSel">중심점</label>
    <select id="focusSel">
      <option>자유(수동)</option>
      <option>태양</option>
      <option selected>지구</option>
      <option>수성</option><option>금성</option><option>달</option><option>화성</option>
      <option>목성</option><option>토성</option><option>천왕성</option><option>해왕성</option><option>명왕성</option>
    </select>
    <label><input id="axisToggle" type="checkbox" checked> 자전축 표시</label>
    <span class="hint">• 좌클릭: 회전 · 휠: 줌 · 우클릭: 팬(자유 모드)</span>
  </div>
</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.155.0/examples/js/controls/OrbitControls.js"></script>

<script>
// ---------- 기본 렌더러/씬/카메라 ----------
const app = document.getElementById('app');
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(app.clientWidth, app.clientHeight);
renderer.setClearColor(0x061024, 1);
app.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, app.clientWidth/app.clientHeight, 0.0001, 1000); // AU 단위
camera.position.set(5,3,5);

// ---------- OrbitControls 추가 ----------
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.enablePan = true;
controls.enableZoom = true;
controls.target.set(0,0,0);
controls.update();

// ---------- 조명 ----------
scene.add(new THREE.AmbientLight(0xffffff, 0.35));
const sunLight = new THREE.PointLight(0xffffff, 2.6, 0, 2);
scene.add(sunLight);

// ---------- helpers ----------
function axisMesh(len, thick=0.006){
  const g = new THREE.CylinderGeometry(thick, thick, len, 12);
  const m = new THREE.MeshBasicMaterial({ color:0xffffff, transparent:true, opacity:0.7, depthWrite:false });
  const cyl = new THREE.Mesh(g, m);
  cyl.position.y = 0;
  return cyl;
}

// ---------- Sun ----------
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(0.1, 64, 64),
  new THREE.MeshStandardMaterial({ color: 0xffd97a, emissive:0xffaa44 })
);
scene.add(sun);
sunLight.position.copy(sun.position);

// ---------- createBody ----------
function createBodySimple({ name, size=0.01, color=0xffffff, axialTiltDeg=0 } = {}) {
  const group = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({ color, roughness: 0.7 });
  const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 32,32), mat);
  group.add(sphere);
  const ax = axisMesh(size*3.0, Math.max(0.003, size*0.06));
  group.add(ax);
  return { name, group, sphere, axis: ax, size };
}

// ---------- planet data (AU 단위) ----------
const planetDefs = [
  { name:'수성', size:0.003, color:0xb4b4b4, a:0.39, e:0.2056409, rotH:58.6462, tilt:0.01, orbit:87.97, inclination:7 },
  { name:'금성', size:0.008, color:0xd8b47d, a:0.72, e:0.0067, rotH:-243.025, tilt:177.36, orbit:224.7, inclination:3.39 },
  { name:'지구', size:0.01, color:0x5fa8ff, a:1.0, e:0.0167, rotH:0.997, tilt:23.44, orbit:365.256, inclination:0,
    moons:[ { name:'달', color:0xcfd6ff, size:0.0027, a:0.00257, orbit:27.322, rotH:655.7, tilt:6.68 } ]
  },
  { name:'화성', size:0.005, color:0xff6b6b, a:1.524, e:0.0934, rotH:1.025, tilt:25.19, orbit:686.98, inclination:1.85,
    moons:[ { name:'포보스', color:0xaaaaaa, size:0.0012, a:0.0000628, orbit:0.3189, rotH:7.65, tilt:0 },
            { name:'데이모스', color:0xcccccc, size:0.0008, a:0.000157, orbit:1.263, rotH:30.3, tilt:0 } ]
  },
  { name:'목성', size:0.1, color:0xc89f68, a:5.204, e:0.0489, rotH:0.414, tilt:3.13, orbit:4332.589, inclination:1.3,
    moons:[ { name:'이오', color:0xe6d27c, size:0.0025, a:0.0028, orbit:1.769, rotH:42.46, tilt:0 },
            { name:'유로파', color:0xdddddd, size:0.0022, a:0.0045, orbit:3.551, rotH:85.2, tilt:0.1 } ]
  },
  { name:'토성', size:0.09, color:0xd8cfae, a:9.582, e:0.0565, rotH:0.444, tilt:26.73, orbit:10759.22, inclination:2.49, ring:true,
    moons:[ { name:'타이탄', color:0xcab47a, size:0.0028, a:0.008, orbit:15.945, rotH:382.7, tilt:0.3 } ]
  },
  { name:'천왕성', size:0.04, color:0x9bd7ff, a:19.201, e:0.0457, rotH:-0.718, tilt:97.77, orbit:30688.5, inclination:0.77,
    moons:[ { name:'티타니아', color:0xcccccc, size:0.0018, a:0.006, orbit:8.706, rotH:208.9, tilt:0 } ]
  },
  { name:'해왕성', size:0.038, color:0x6aa7ff, a:30.047, e:0.0113, rotH:0.67, tilt:28.32, orbit:60182.0, inclination:1.77,
    moons:[ { name:'트리톤', color:0xcfd6ff, size:0.0022, a:0.0065, orbit:5.877, rotH:141.0, tilt:0, retrogradeOrbit:true } ]
  },
  { name:'명왕성', size:0.018, color:0x999999, a:39.482, e:0.2488, rotH:6.387, tilt:122.53, orbit:90560.0, inclination:17.16,
    moons:[ { name:'카론', color:0xcccccc, size:0.005, a:0.002, orbit:6.387, rotH:153.3, tilt:0 } ]
  }
];

// ---------- planets ----------
const planetStates = [];
for(const def of planetDefs){
  const b = def.a * Math.sqrt(1 - (def.e||0)**2);
  const curve = new THREE.EllipseCurve( - (def.e||0)*def.a, 0, def.a, b, 0, 2*Math.PI, false, 0 );
  const points = curve.getPoints(256);
  const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points.map(p=>new THREE.Vector3(p.x,0,p.y)));
  const orbitMaterial = new THREE.LineBasicMaterial({ color:def.color, transparent:true, opacity:0.35 });
  const orbitLine = new THREE.LineLoop(orbitGeometry, orbitMaterial);
  scene.add(orbitLine);

  const body = createBodySimple({ name:def.name, size:def.size, color:def.color, axialTiltDeg:def.tilt });
  scene.add(body.group);

  const moons = [];
  if(def.moons){
    for(const m of def.moons){
      const mBody = createBodySimple({ name:m.name, size:m.size, color:m.color, axialTiltDeg:m.tilt });
      body.group.add(mBody.group);
      moons.push({ def:m, node:mBody, orbitAngle:0 });
    }
  }

  planetStates.push({ def, node:body, moons, a:def.a, b, e:def.e||0, orbitLine, orbitAngle:Math.random()*Math.PI*2, rotPeriodHours:def.rotH, _destroyed:false });
}

// ---------- tick ----------
let last = performance.now();
let timeScale = 2;
function tick(now){
  const dtSec = (now-last)/1000; last=now;
  const dtDays = dtSec * timeScale;

  sun.rotation.y += dtDays * (2*Math.PI / 25); // 태양 회전

  for(const ps of planetStates){
    ps.orbitAngle += dtDays*(2*Math.PI/ps.def.orbit);
    const ang = ps.orbitAngle, a = ps.a, b = ps.b, e = ps.e;
    const x = a*(Math.cos(ang)-e), z = b*Math.sin(ang);
    ps.node.group.position.set(x,0,z);

    if(ps.node.group.children[0]) ps.node.group.children[0].rotation.y += dtDays*(2*Math.PI/Math.abs(ps.rotPeriodHours/24));

    for(let i=0;i<ps.moons.length;i++){
      const m = ps.moons[i]; m.orbitAngle += dtDays*(2*Math.PI/m.def.orbit);
      const mx = Math.cos(m.orbitAngle)*m.def.a, mz = -Math.sin(m.orbitAngle)*m.def.a;
      m.node.group.position.set(mx,0,mz);
    }
  }

  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

addEventListener('resize',()=>{ camera.aspect = app.clientWidth/app.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(app.clientWidth,app.clientHeight); });
</script>
</body>
</html>
